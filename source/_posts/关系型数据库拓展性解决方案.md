---
title: 关系型数据库拓展性解决方案
date: 2022-09-08 11:18:09
tags:
---

实现一个关系型数据库的可拓展性有很多方法：
1. 在应用层划分数据，将不同的数据分片划分到不同的关系数据库上，如 MySQL sharding；
2. 或者在关系数据库内部支持数据自动分片，如 Microsoft SQL Azure；
3. 或者干脆从存储引擎开始重新写一个全新的分布式数据库，如 Spanner、OceanBase 和 TiDB.

### 方式一：引入中间层，应用层数据分片
最常见最简单的方式就是应用层按照规则将数据拆分成多个分片，分布到多个数据库节点，并引入一个中间层来对应用屏蔽后端的数据库拆分细节。以 MySQL Sharding 架构为例，如下图：
![](/img/TiDB-Paper/1.png)
整个架构可以分为：
* **中间层 dbproxy 集群**：解析 MySQL 协议、执行 SQL 路由、SQL 过滤、读写分离、结果归并/排序/分组等。由多个无状态的 dpproxy 进程组成。另外可以在客户端与中间层之间加一个 LVS（Linux Virtual Server）对客户端请求进行负载均衡。
* **数据库组**：每一个数据库组由 N 台数据库组成，单主多副本。主节点负责所有的写事务及强一致读事务，副本可以负责一些一致性要求不高的读事务。主备复制采用 binlog 方式.
* **元数据服务器**：主要负责维护数据分片规则和组内选主。元数据服务器也需要多副本实现高可用，一般使用 Zookeeper 实现。
* **常驻进程**：安装在每一台数据库服务器上，与 Zookeeper 交互，负责监控、单点切换等。

<br>

MySQL Sharding 集群一般按照用户 id 进行哈希分区，随着数据量的增长，会出现以下情况可能需要扩容：
* 集群的容量不够
* 单个用户的数据量太大。

**对于第一种情况**，MySQL Sharding 集群往往采用双倍扩容方案，从 2 台服务器扩到 4 台，接着再扩到 8 台...假设现在有两个数据库组，db1 = {A0, A1}, db2 = {B0, B1}. hash(id) % 2 为奇数的数据放在 db1，为偶数的数据放在 db2. 常见的一种扩容方式如下：
1. 停止写服务，等待主备完全同步后解除 A0 与 A1、B0 与 B1 之间的主备关系。
2. 修改中间层的映射规则，将 hash(id) % 4 = 1 的用户数据映射到 A1，hash(id) % 4 = 3 的用户数据映射到 B1.
3. 开启写服务，hash(id) % 4 = 0, 1, 2, 3 的数据分别写入到 A0、A1、B0、B1，就相当于有一半的数据分别从 A0、B0 迁移到 A1 和 B1.
4. 分别给 A0、A1、B0、B1 增加一个副本。

> 可以看到，扩容过程需要停服一段时间，需要人工参与，难以完全自动化，而且扩容过程若发生了服务器故障会使得扩容变得非常复杂。

**对于第二种情况**，可以使用其他的分片方式，或者在应用层定期统计大用户，并且将这些用户的数据按照数据量拆分到多个数据库组，然而维护这些拆分元信息也需要付出代价。


### 方式二：Microsoft SQL Azure

